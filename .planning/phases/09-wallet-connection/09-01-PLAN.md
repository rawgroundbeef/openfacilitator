---
phase: 09-wallet-connection
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/dashboard/src/components/rewards/claim-modal.tsx
  - apps/dashboard/src/components/rewards/claim-button.tsx
  - apps/dashboard/src/lib/api.ts
  - apps/dashboard/src/app/rewards/page.tsx
  - packages/server/src/routes/rewards.ts
autonomous: true

must_haves:
  truths:
    - "User can connect Solana wallet at claim time"
    - "User can confirm claim to connected wallet"
    - "Claim wallet is stored on the claim record (not permanently on account)"
    - "Claiming flow shows wallet address before confirmation"
  artifacts:
    - path: "apps/dashboard/src/components/rewards/claim-modal.tsx"
      provides: "ClaimModal component with wallet connection flow"
      min_lines: 100
    - path: "apps/dashboard/src/components/rewards/claim-button.tsx"
      provides: "ClaimButton component to trigger claim flow"
      min_lines: 30
    - path: "packages/server/src/routes/rewards.ts"
      provides: "initiateClaim endpoint"
      contains: "initiate"
  key_links:
    - from: "apps/dashboard/src/components/rewards/claim-button.tsx"
      to: "apps/dashboard/src/components/rewards/claim-modal.tsx"
      via: "opens modal on click"
      pattern: "ClaimModal"
    - from: "apps/dashboard/src/components/rewards/claim-modal.tsx"
      to: "/api/rewards/claims/:id/initiate"
      via: "POST request with claim_wallet"
      pattern: "initiateClaim|/api/rewards/claims"
---

<objective>
Create the claim wallet connection flow for users to receive $OPEN tokens.

Purpose: Users need to connect a Solana wallet at claim time to specify where tokens should be sent. The claiming wallet is ephemeral - users can use a different wallet for each claim.

Output: ClaimModal component, ClaimButton component, and initiateClaim API endpoint that stores the wallet address on the claim record.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-wallet-connection/09-CONTEXT.md
@.planning/phases/09-wallet-connection/09-RESEARCH.md

# Key patterns to follow
@apps/dashboard/src/components/rewards/enrollment-modal.tsx
@apps/dashboard/src/components/providers/solana-provider.tsx
@packages/server/src/db/reward-claims.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ClaimModal and ClaimButton components</name>
  <files>
    - apps/dashboard/src/components/rewards/claim-modal.tsx
    - apps/dashboard/src/components/rewards/claim-button.tsx
  </files>
  <action>
Create ClaimModal component following the EnrollmentModal pattern but SIMPLER (no signature verification needed):

**ClaimModal (claim-modal.tsx):**
- Props: `{ open, onOpenChange, claimId, rewardAmount, onSuccess }`
- State machine: `'idle' | 'connecting' | 'confirming' | 'processing' | 'success' | 'error'`
- Use existing Solana wallet hooks: `useWallet()`, `useWalletModal()`
- Flow:
  1. `idle` state: Show "Connect Solana Wallet" button with clear messaging "$OPEN tokens will be sent to your connected wallet"
  2. `connecting` state: Show spinner after `setVisible(true)` is called
  3. `confirming` state (triggered when `connected && publicKey`): Show wallet address prominently, reward amount, and "Confirm Claim" button
  4. `processing` state: Show spinner while API call in progress
  5. `success` state: Show success message with wallet address tokens were sent to, "Done" button
  6. `error` state: Show error message with "Try Again" button

Key implementation details:
- Use `useEffect` to transition from `connecting` to `confirming` when wallet connects (see enrollment-modal.tsx:48-53 pattern)
- Call `disconnect()` on modal close to clean up wallet state (ephemeral connection)
- Display wallet address using `publicKey.toBase58()`
- Call `api.initiateClaim(claimId, publicKey.toBase58())` in confirming step
- Format reward amount with proper decimals (divide by appropriate factor for $OPEN display)

**ClaimButton (claim-button.tsx):**
- Props: `{ claimId, rewardAmount, disabled?, className? }`
- Renders a Button that opens ClaimModal
- Button text: "Claim Rewards" or "Claim {amount} $OPEN"
- Manages modal open state internally
- Disabled state for when claim is not ready

Both components use existing UI components from @/components/ui (Dialog, Button) and icons from lucide-react (Wallet, Loader2, CheckCircle, AlertCircle).
  </action>
  <verify>
- Files exist and compile without TypeScript errors
- ClaimModal imports useWallet and useWalletModal correctly
- ClaimButton renders and toggles modal
- Run: `cd apps/dashboard && npm run build` passes
  </verify>
  <done>
ClaimModal shows 5-state flow (idle -> connecting -> confirming -> processing -> success/error) with Solana wallet connection. ClaimButton triggers modal open.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add initiateClaim API endpoint and client method</name>
  <files>
    - packages/server/src/routes/rewards.ts
    - apps/dashboard/src/lib/api.ts
  </files>
  <action>
**Backend endpoint (packages/server/src/routes/rewards.ts):**

Add POST `/api/rewards/claims/:id/initiate` endpoint:
- Requires authentication (existing auth middleware)
- Request body: `{ claim_wallet: string }` (Solana address)
- Validations:
  1. Claim exists and belongs to authenticated user
  2. Claim status is 'pending' (not already processing/completed/failed)
  3. claim_wallet is a valid Solana address format (32-44 chars, base58)
- Updates claim record:
  - Set `claim_wallet` to provided address
  - Set `status` to 'processing' (marks as ready for Phase 10 token transfer)
- Returns: `{ success: true, claim: RewardClaimRecord }` or error

Use existing `updateRewardClaim()` from `@/db/reward-claims.ts` and `getRewardClaimById()` for validation.

Basic Solana address validation (not full validation, just format check):
```typescript
function isValidSolanaAddress(address: string): boolean {
  // Base58 characters, 32-44 chars typical for Solana addresses
  return /^[1-9A-HJ-NP-Za-km-z]{32,44}$/.test(address);
}
```

**API client method (apps/dashboard/src/lib/api.ts):**

Add to ApiClient class:
```typescript
async initiateClaim(claimId: string, claimWallet: string): Promise<{
  success: boolean;
  claim?: RewardClaimRecord;
  error?: string;
}> {
  return this.request(`/api/rewards/claims/${claimId}/initiate`, {
    method: 'POST',
    body: JSON.stringify({ claim_wallet: claimWallet }),
  });
}
```

Also add the RewardClaim type to api.ts if not present (mirror RewardClaimRecord from server types).
  </action>
  <verify>
- API endpoint responds to POST request
- Test with curl: `curl -X POST http://localhost:5002/api/rewards/claims/test-id/initiate -H "Content-Type: application/json" -d '{"claim_wallet":"test"}' --cookie "..."` returns auth error (expected without valid session)
- API client method exists and TypeScript compiles
- Run: `cd packages/server && npm run build` passes
  </verify>
  <done>
POST /api/rewards/claims/:id/initiate endpoint validates user ownership and claim status, stores claim_wallet, sets status to 'processing'. API client has initiateClaim method.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate ClaimButton into rewards page</name>
  <files>
    - apps/dashboard/src/app/rewards/page.tsx
  </files>
  <action>
Add ClaimButton to the rewards page in the appropriate location:

1. Import ClaimButton component
2. Add ClaimButton to campaign ended state:
   - Show when: campaign has ended AND user met threshold AND claim not already processed
   - Position: Below the "Campaign Ended" card or in the eligible rewards message area
   - Pass: claimId (from user's claim record for this campaign), rewardAmount (final_reward_amount)

3. To get claim data, may need to:
   - Add API call to fetch user's claim record for current campaign if not already available
   - Or extend existing campaign history endpoint to include pending claim info

The button should only appear when:
- Campaign status is 'ended'
- User met the threshold (has a claim record)
- Claim status is 'pending' (not yet initiated)

If claim status is 'processing' or 'completed', show status text instead of button:
- 'processing': "Claim in progress..."
- 'completed': "Claimed to {truncated_wallet}" with explorer link

Note: For this task, focus on adding the ClaimButton component. The actual fetching of claim data may need a simple API addition to get user's claim for a campaign (getMyClaimForCampaign).
  </action>
  <verify>
- ClaimButton appears on rewards page when campaign ended and threshold met
- Button is disabled or hidden when claim already processing/completed
- Run: `npm run dev` in apps/dashboard and navigate to /rewards - no console errors
  </verify>
  <done>
ClaimButton integrated into rewards page, appears after campaign ends for eligible users with pending claims.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Full flow test (requires ended campaign with user meeting threshold):
   - Navigate to /rewards
   - See ClaimButton for pending claim
   - Click to open ClaimModal
   - Connect Solana wallet
   - See confirmation with wallet address
   - Click "Confirm Claim" (will store wallet, set to processing)
   - See success state

2. Build verification:
   - `cd apps/dashboard && npm run build` - no errors
   - `cd packages/server && npm run build` - no errors

3. API test:
   - Endpoint returns 401 without auth
   - Endpoint returns 400 for invalid claim_wallet
   - Endpoint returns 404 for non-existent claim
</verification>

<success_criteria>
- ClaimModal connects Solana wallet using existing adapter (no signature required)
- ClaimButton triggers modal and is conditionally rendered
- initiateClaim API stores wallet address on claim record and sets status to 'processing'
- Wallet connection is ephemeral (disconnects on modal close)
- Clear user messaging: "Connect Solana wallet to receive $OPEN tokens"
</success_criteria>

<output>
After completion, create `.planning/phases/09-wallet-connection/09-01-SUMMARY.md`
</output>
