---
phase: 02-auth-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/utils/admin.ts
  - packages/server/src/middleware/auth.ts
  - packages/server/src/db/reward-addresses.ts
  - packages/server/src/db/facilitators.ts
  - packages/server/src/routes/rewards.ts
  - packages/server/src/server.ts
  - packages/server/.env.example
autonomous: true

must_haves:
  truths:
    - "Calling isAdmin(userId) returns true only for IDs in ADMIN_USER_IDS"
    - "requireAdmin middleware blocks non-admin users with 403"
    - "isUserEnrolledInRewards checks reward_addresses table"
    - "isFacilitatorOwner checks facilitators.owner_address"
    - "GET /api/rewards/status returns enrollment and admin status"
    - "POST /api/rewards/enroll endpoint exists and validates input"
  artifacts:
    - path: "packages/server/src/utils/admin.ts"
      provides: "isAdmin utility function"
      exports: ["isAdmin"]
    - path: "packages/server/src/middleware/auth.ts"
      provides: "requireAdmin middleware"
      exports: ["requireAuth", "optionalAuth", "requireAdmin"]
    - path: "packages/server/src/routes/rewards.ts"
      provides: "Rewards API endpoints"
      exports: ["rewardsRouter"]
  key_links:
    - from: "packages/server/src/middleware/auth.ts"
      to: "packages/server/src/utils/admin.ts"
      via: "import isAdmin"
      pattern: "import.*isAdmin.*from.*utils/admin"
    - from: "packages/server/src/routes/rewards.ts"
      to: "packages/server/src/db/reward-addresses.ts"
      via: "CRUD operations"
      pattern: "(createRewardAddress|getRewardAddressesByUser)"
    - from: "packages/server/src/server.ts"
      to: "packages/server/src/routes/rewards.ts"
      via: "router mount"
      pattern: "app\\.use.*rewardsRouter"
---

<objective>
Create backend infrastructure for rewards integration: admin identification via ADMIN_USER_IDS, enrollment status helpers, and rewards API routes.

Purpose: Establish the backend foundation that Phase 3 (Solana Address Management) will build upon. This phase creates the infrastructure layer - endpoints exist but full user registration (AUTH-01: email + Solana wallet) requires address verification implemented in Phase 3.

Output: Admin utilities, requireAdmin middleware, enrollment helpers, and /api/rewards/* endpoints ready for Phase 3 integration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-auth-integration/02-RESEARCH.md

# Relevant source files
@packages/server/src/middleware/auth.ts
@packages/server/src/db/reward-addresses.ts
@packages/server/src/db/facilitators.ts
@packages/server/src/server.ts
@packages/server/.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin utility and middleware</name>
  <files>
    packages/server/src/utils/admin.ts
    packages/server/src/middleware/auth.ts
    packages/server/.env.example
  </files>
  <action>
    1. Create new file `packages/server/src/utils/admin.ts`:
       - Parse ADMIN_USER_IDS env var (comma-separated, trim whitespace, filter empty)
       - Export `isAdmin(userId: string): boolean` that checks if userId is in the list
       - Handle empty/undefined env var gracefully (returns false for all)

    2. Add to `packages/server/src/middleware/auth.ts`:
       - Import isAdmin from utils/admin.ts
       - Add `requireAdmin` middleware that:
         - First calls requireAuth logic to validate session
         - Then checks isAdmin(req.user.id)
         - Returns 403 with `{ error: 'Forbidden', message: 'Admin access required' }` if not admin
         - Calls next() if admin
       - Export requireAdmin

    3. Add to `packages/server/.env.example`:
       - Add `ADMIN_USER_IDS=` entry with comment explaining format (comma-separated user IDs)
       - Place in a new "Rewards Program" section
  </action>
  <verify>
    - `grep -r "isAdmin" packages/server/src/utils/admin.ts` shows function
    - `grep -r "requireAdmin" packages/server/src/middleware/auth.ts` shows middleware
    - `grep -r "ADMIN_USER_IDS" packages/server/.env.example` shows env var
    - TypeScript compiles: `cd packages/server && npx tsc --noEmit`
  </verify>
  <done>
    isAdmin utility returns correct boolean based on ADMIN_USER_IDS env var.
    requireAdmin middleware blocks non-admins with 403.
    Environment variable documented in .env.example.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add enrollment status helpers</name>
  <files>
    packages/server/src/db/reward-addresses.ts
    packages/server/src/db/facilitators.ts
  </files>
  <action>
    1. Add to `packages/server/src/db/reward-addresses.ts`:
       - Add `isUserEnrolledInRewards(userId: string): boolean`
       - SQL: `SELECT 1 FROM reward_addresses WHERE user_id = ? LIMIT 1`
       - Returns true if row exists, false otherwise

    2. Add to `packages/server/src/db/facilitators.ts`:
       - Add `isFacilitatorOwner(userId: string): boolean`
       - SQL: `SELECT 1 FROM facilitators WHERE owner_address = ? LIMIT 1`
       - Note: owner_address stores user.id (lowercase), so normalize input with .toLowerCase()
       - Returns true if user owns at least one facilitator
  </action>
  <verify>
    - `grep -r "isUserEnrolledInRewards" packages/server/src/db/reward-addresses.ts` shows function
    - `grep -r "isFacilitatorOwner" packages/server/src/db/facilitators.ts` shows function
    - TypeScript compiles: `cd packages/server && npx tsc --noEmit`
  </verify>
  <done>
    isUserEnrolledInRewards returns true when user has reward_addresses records.
    isFacilitatorOwner returns true when user owns facilitators.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create rewards API routes and wire to server</name>
  <files>
    packages/server/src/routes/rewards.ts
    packages/server/src/server.ts
  </files>
  <action>
    1. Create new file `packages/server/src/routes/rewards.ts`:
       - Import Router from express, requireAuth from middleware/auth
       - Import isAdmin from utils/admin, isUserEnrolledInRewards from db/reward-addresses
       - Import isFacilitatorOwner from db/facilitators
       - Import createRewardAddress, getRewardAddressesByUser from db/reward-addresses
       - Import z from zod for validation

       Create router with these endpoints:

       GET /status (requireAuth)
       - Returns user's rewards status:
         ```json
         {
           "isEnrolled": boolean,
           "isAdmin": boolean,
           "isFacilitatorOwner": boolean,
           "addresses": RewardAddressRecord[]
         }
         ```

       POST /enroll (requireAuth)
       - Body validation with zod:
         - chain_type: z.enum(['solana', 'evm'])
         - address: z.string().min(1)
       - Check if address already exists for user (return 409 if duplicate)
       - Call createRewardAddress({ user_id: req.user.id, chain_type, address })
       - Return 201 with the created address record
       - Handle null return (unique constraint) with 409 Conflict
       - NOTE: This endpoint will be called from Phase 3's address management UI
         after address verification is implemented. For now, it exists but is not
         exposed to users via UI.

       Export rewardsRouter

    2. Wire router in `packages/server/src/server.ts`:
       - Import rewardsRouter from './routes/rewards.js'
       - Add `app.use('/api/rewards', rewardsRouter);` after adminRouter mount
  </action>
  <verify>
    - `grep -r "rewardsRouter" packages/server/src/routes/rewards.ts` shows export
    - `grep -r "/api/rewards" packages/server/src/server.ts` shows mount
    - TypeScript compiles: `cd packages/server && npx tsc --noEmit`
    - Server starts without errors: Start server, hit `GET /api/rewards/status` (should return 401 without auth)
  </verify>
  <done>
    GET /api/rewards/status returns enrollment, admin, and facilitator owner status.
    POST /api/rewards/enroll creates reward_address and returns 201.
    Duplicate addresses return 409 Conflict.
    Routes mounted at /api/rewards in server.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation passes:
   ```bash
   cd packages/server && npx tsc --noEmit
   ```

2. Server starts successfully:
   ```bash
   cd packages/server && npm run dev
   # Should start without errors
   ```

3. API structure correct:
   ```bash
   # Without auth (should 401)
   curl http://localhost:5002/api/rewards/status

   # Response should be: {"error":"Unauthorized","message":"Authentication required"}
   ```
</verification>

<success_criteria>
- packages/server/src/utils/admin.ts exports isAdmin function
- packages/server/src/middleware/auth.ts exports requireAdmin middleware
- packages/server/src/db/reward-addresses.ts exports isUserEnrolledInRewards
- packages/server/src/db/facilitators.ts exports isFacilitatorOwner
- packages/server/src/routes/rewards.ts exports rewardsRouter with /status and /enroll
- packages/server/src/server.ts mounts rewardsRouter at /api/rewards
- packages/server/.env.example documents ADMIN_USER_IDS
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-auth-integration/02-01-SUMMARY.md`
</output>
