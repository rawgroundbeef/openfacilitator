---
phase: 20-recurring-payment-engine
plan: 04
type: execute
wave: 3
depends_on: ["20-01"]
files_modified:
  - packages/server/src/services/x402-client.ts
  - packages/server/src/services/subscription-billing.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Base chain USDC payments execute successfully via x402"
    - "Subscription billing service uses Base payments when Base is preferred or fallback chain"
  artifacts:
    - path: "packages/server/src/services/x402-client.ts"
      provides: "Base chain x402 payment support"
      exports: ["makeX402Payment", "makeBaseX402Payment"]
    - path: "packages/server/src/services/subscription-billing.ts"
      provides: "Full multi-chain billing with Base support"
  key_links:
    - from: "packages/server/src/services/subscription-billing.ts"
      to: "packages/server/src/services/x402-client.ts"
      via: "makeBaseX402Payment or makeX402Payment with chain param"
      pattern: "makeX402Payment|makeBaseX402Payment"
---

<objective>
Add Base chain x402 payment support to enable full multi-chain subscription billing.

Purpose: Close the gap where Base chain payments return "not yet implemented" in subscription-billing.ts.
Output: Working Base USDC payments via x402 protocol, integrated with subscription billing service.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-recurring-payment-engine/20-VERIFICATION.md

# Gap being closed
The verification found that subscription-billing.ts lines 184-200 return "Base chain payments not yet implemented" because x402-client.ts only supports Solana.

# Current x402-client.ts
@packages/server/src/services/x402-client.ts

# Current subscription-billing.ts
@packages/server/src/services/subscription-billing.ts

# Existing Base chain infrastructure
@packages/server/src/services/wallet.ts (has getBaseUSDCBalance, Base publicClient)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Base chain x402 payment support</name>
  <files>packages/server/src/services/x402-client.ts</files>
  <action>
Extend x402-client.ts to support Base chain USDC payments:

1. Add Base USDC constants:
   ```typescript
   const BASE_USDC_ADDRESS = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
   ```

2. Add viem imports for Base chain:
   ```typescript
   import { createWalletClient, http, parseUnits, encodeFunctionData } from 'viem';
   import { base } from 'viem/chains';
   import { privateKeyToAccount } from 'viem/accounts';
   ```

3. Create `makeBaseX402Payment` function:
   - Accept same interface as makeX402Payment but for EVM
   - Step 1: Make initial request, handle 402 response
   - Step 2: Parse payment requirements (expect network: 'base')
   - Step 3: Check USDC balance via existing basePublicClient
   - Step 4: Create and sign ERC-20 transfer transaction
   - Step 5: Serialize transaction for x402 payload
   - Step 6: Retry request with X-PAYMENT header
   - Return X402Response with txHash

4. Helper function `createBaseUSDCTransfer`:
   - Use viem walletClient with privateKeyToAccount
   - Create ERC-20 transfer to recipient
   - Sign transaction
   - Return serialized transaction

5. Update or add chain detection in makeX402Payment:
   - If network is 'base', delegate to makeBaseX402Payment
   - Keep Solana flow for 'solana' networks

Export makeBaseX402Payment (or enhance makeX402Payment to handle both).
  </action>
  <verify>TypeScript compiles: `cd packages/server && npx tsc --noEmit`</verify>
  <done>Base chain x402 payment function exists and compiles</done>
</task>

<task type="auto">
  <name>Task 2: Integrate Base payments into subscription billing</name>
  <files>packages/server/src/services/subscription-billing.ts</files>
  <action>
Update subscription-billing.ts to use Base x402 payments:

1. Import the new Base payment function:
   ```typescript
   import { makeX402Payment, makeBaseX402Payment } from './x402-client.js';
   ```

2. Replace the "not yet implemented" block (lines 184-200) with actual Base payment:
   ```typescript
   if (chain === 'base') {
     // Make Base payment via x402
     const paymentResult = await makeBaseX402Payment(
       X402_JOBS_PAYMENT_URL,
       { userId },
       privateKey,
       wallet.address
     );

     // Handle result same as Solana flow...
   }
   ```

3. Ensure Base payment result handling mirrors Solana:
   - Check insufficientBalance flag
   - Log payment attempts via createSubscriptionPayment
   - Create/extend subscription on success
   - Return appropriate PaymentResult

4. Remove the hardcoded failure for Base chain.
  </action>
  <verify>TypeScript compiles: `cd packages/server && npx tsc --noEmit`</verify>
  <done>Base payments integrated into billing service, no more "not implemented" error</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. makeBaseX402Payment function exists in x402-client.ts
3. subscription-billing.ts no longer returns "not yet implemented" for Base
4. Base payment flow follows same pattern as Solana (check balance, sign, send, log)
</verification>

<success_criteria>
- Base chain USDC payments can be made via x402 protocol
- Subscription billing uses Base payments when appropriate
- Payment attempts are logged to subscription_payments table
- Fallback logic works: Solana insufficient â†’ Base attempted (and vice versa)
</success_criteria>

<output>
After completion, create `.planning/phases/20-recurring-payment-engine/20-04-SUMMARY.md`
</output>
